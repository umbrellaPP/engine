# 当前的模拟器工作流
0. 对于发布版本，模拟器 和 Native JS 引擎是一个预编译好的版本，所以直接可以直接进行模拟器预览。而对于开发版本，需要手动做以下编译操作

1.  编译原生模拟器
    - 环境变量里需要设置好 cmake 的路径
    - 在 engine-native 仓库下执行
    ```shell
    npm install
    gulp gen-simulator 
    ```
    执行完成后，会在 engine-native/simulator 路径下生成一个模拟器工程  
    命令 `gulp gen-simulator-release` 是给发布版本用的，除了编译模拟器之外，另外多做了一次清除模拟器工程的操作，避免发布版本的编辑器包体过大

2. 编译 Native JS 引擎  
    在编辑器里边执行 **开发者** -> **编译原生模拟器引擎**  
    编译结果会放到 engine/bin/.cache/dev/native-preview 缓存目录下

3. 编译完成后，就可以直接进行模拟器预览了。  
预览这块做的工作主要是：
    - 编译 jsb-adapter，编译结果会放到 engine/bin/.cache/dev/native-preview-adapter 缓存目录下
    - 资源拷贝，包括 jsb-adapter, Native JS engine, import-map.json, system.bundle.js 和 polyfills.bundle.js
    - 写入 settings.js
    - EJS 模板编译（main.ejs, application.ejs）
    - 运行模拟器
    - 打开模拟器调试面板

# 模拟器相关的需求
## 编辑器相关
- 优化偏好设置里模拟器相关的配置 https://github.com/cocos-creator/3d-tasks/issues/7149

## 原生相关
- 统一 cmake 的位置，现在编辑器在构建原生工程的时候，内置了一个 cmake，编译模拟器的时候，也引用了一个环境变量里的 cmake，这块应该可以考虑将 cmake 统一放到 engine-native/external 仓库里 https://github.com/cocos-creator/3d-tasks/issues/5944
- 提供 resize window 相关的能力，编辑器这边有个需求，需要动态修改模拟器的窗口尺寸，这个在 Creator 2.x 版本里是通过 TCP 通信实现的，由编辑器告诉原生模拟器窗口尺寸，模拟器在原生层上进行窗口 resize。实际上 resize window 应该是桌面游戏应该具备的能力，可以考虑提供类似 jsb.resizeWindow(width, height) 的接口, JS 引擎直接去调用就好了。
- 除了 jsb.resizeWindow(width, height), 引擎这边还需要 jsb.requestFullScreen(), jsb.exitFullScreen(), jsb.onExitFullScreen(cb) 这些能力用来做全屏控制。
- BUG: 模拟器关闭异常 https://github.com/cocos-creator/3d-tasks/issues/6576

## 文档补充
- 模拟器预览和原生模拟器定制相关说明 https://github.com/cocos-creator/3d-tasks/issues/7514
